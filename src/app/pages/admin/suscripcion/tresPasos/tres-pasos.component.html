<div class="suscripcion-page">
  <header class="suscripcion-header">
    <h1>Suscripci√≥n a Noticias360</h1>
    <a routerLink="/" class="link-volver">‚¨Ö Volver al inicio</a>
  </header>

  <!-- Pasos -->
  <div class="steps">
    <div class="step-item" [class.active]="step() === 1">
      <span>1</span> Plan
    </div>
    <div class="step-item" [class.active]="step() === 2">
      <span>2</span> Datos
    </div>
    <div class="step-item" [class.active]="step() === 3">
      <span>3</span> Pago
    </div>
  </div>

  <!-- Contenido -->
  <section class="suscripcion-body">
    <!-- PASO 1 -->
    <ng-container *ngIf="step() === 1">
      <div *ngIf="planesLoading()" class="info-msg">Cargando planes...</div>
      <div *ngIf="planesError()" class="error-msg">{{ planesError() }}</div>

      <div class="plans-grid" *ngIf="!planesLoading() && !planesError()">
        <div
          class="plan-card"
          *ngFor="let plan of planes()"
          [class.selected]="selectedPlan()?.id === plan.id"
          [class.disabled]="isPlanDisabled(plan)"
          (click)="seleccionarPlan(plan)">

          <div class="plan-header-row">
            <h3>{{ plan.nombre }}</h3>

            <!-- Badges -->
            <span class="plan-badge current" *ngIf="isUserPlan(plan)">
          Plan actual
        </span>
            <span class="plan-badge blocked" *ngIf="!isUserPlan(plan) && isPlanDisabled(plan)">
          No disponible
        </span>
          </div>

          <p class="plan-desc">{{ plan.descripcion }}</p>

          <p class="plan-price">
            S/. {{ plan.precio | number:'1.2-2' }}
            <span class="plan-period"
                  *ngIf="plan.nombre && plan.nombre.toLowerCase().includes('mensual')">
          /mes
        </span>
          </p>

          <ul class="plan-features">
            <li *ngFor="let feature of getPlanFeatures(plan)">
              {{ feature }}
            </li>
          </ul>

        </div>

        <div *ngIf="planes().length === 0 && !planesLoading()" class="info-msg">
          No hay planes disponibles por el momento.
        </div>
      </div>

      <div class="step-actions">
        <button
          type="button"
          class="btn danger"
          (click)="openCancelConfirm()">
          Cancelar suscripci√≥n
        </button>


        <button class="btn primary"
                [disabled]="!selectedPlan()"
                (click)="continuarDesdeStep1()">
          Continuar ‚ûú
        </button>
      </div>

    </ng-container>


    <!-- PASO 2 -->
    <ng-container *ngIf="step() === 2 && selectedPlan() as planSel">
      <div class="step2-layout">
        <!-- Form -->
        <form [formGroup]="customerForm" class="customer-form" (ngSubmit)="goToStep3()">
          <h2>Datos del titular</h2>

          <label>
            Nombre completo
            <input type="text" formControlName="nombre" />
          </label>
          <div class="field-error"
               *ngIf="customerForm.get('nombre')?.invalid && customerForm.get('nombre')?.touched">
            Ingresa un nombre v√°lido.
          </div>

          <label>
            Correo electr√≥nico
            <input type="email" formControlName="email" />
          </label>
          <div class="field-error"
               *ngIf="customerForm.get('email')?.invalid && customerForm.get('email')?.touched">
            Ingresa un correo v√°lido.
          </div>

          <div class="doc-row">
            <label>
              Tipo documento
              <select formControlName="tipoDocumento">
                <option value="DNI">DNI</option>
                <option value="RUC">RUC</option>
                <option value="CE">CE</option>
              </select>
            </label>

            <label>
              N¬∞ documento
              <input type="text" formControlName="documento" />
            </label>
          </div>
          <div class="field-error"
               *ngIf="customerForm.get('documento')?.invalid && customerForm.get('documento')?.touched">
            Ingresa un documento v√°lido.
          </div>

          <div class="step-actions">
            <button type="button" class="btn ghost" (click)="backToStep1()">
              ‚¨Ö Volver
            </button>
            <button type="submit" class="btn primary">
              Continuar al pago ‚ûú
            </button>
          </div>
        </form>

        <!-- Resumen plan -->
        <aside class="plan-summary-card">
          <h2>Resumen del plan</h2>
          <p class="plan-name">{{ planSel.nombre }}</p>
          <p class="plan-desc">{{ planSel.descripcion }}</p>
          <p class="plan-price">
            S/. {{ planSel.precio | number:'1.2-2' }}
            <span class="plan-period"
                  *ngIf="planSel.nombre && planSel.nombre.toLowerCase().includes('mensual')">
              /mes
            </span>
          </p>
        </aside>
      </div>
    </ng-container>

    <!-- PASO 3 -->
    <ng-container *ngIf="step() === 3 && selectedPlan() as planSel">
      <div class="step3-layout">
        <aside class="plan-summary-card">
          <h2>Confirmar pago</h2>
          <p class="plan-name">{{ planSel.nombre }}</p>
          <p class="plan-desc">{{ planSel.descripcion }}</p>
          <p class="plan-price">
            S/. {{ planSel.precio | number:'1.2-2' }}
            <span class="plan-period"
                  *ngIf="planSel.nombre && planSel.nombre.toLowerCase().includes('mensual')">
              /mes
            </span>
          </p>
        </aside>

        <section class="payment-panel">
          <h2>M√©todo de pago</h2>

          <div class="method-row">
            <button type="button"
                    class="chip"
                    [class.active]="paymentMethod() === 'card'"
                    (click)="setPaymentMethod('card')">
              üí≥ Tarjeta
            </button>
            <button type="button"
                    class="chip"
                    [class.active]="paymentMethod() === 'yape'"
                    (click)="setPaymentMethod('yape')">
              üì± Yape
            </button>
            <button type="button"
                    class="chip"
                    [class.active]="paymentMethod() === 'plin'"
                    (click)="setPaymentMethod('plin')">
              üí∏ Plin
            </button>
          </div>

          <p *ngIf="paymentStatus() === 'idle'">
            Al confirmar, se procesar√° el pago mediante tu pasarela Culqi en el backend.
          </p>

          <!-- üîπ Overlay de √âXITO con contador y logout -->
          <div class="success-overlay" *ngIf="showSuccess()">
            <div class="success-modal">
              <div class="success-icon">‚úî</div>
              <h2>Pago exitoso</h2>
              <p>{{ paymentMessage() }}</p>

              <p class="success-hint">
                Por favor vuelva a iniciar sesi√≥n mientras cargamos los datos.
              </p>

              <p class="success-countdown">
                La sesi√≥n se cerrar√° autom√°ticamente en
                <strong>{{ logoutCountdown() }}</strong> segundos.
              </p>

              <div class="success-actions">
                <button class="btn primary" (click)="confirmLogoutAfterPurchase()">
                  Aceptar y cerrar sesi√≥n ahora
                </button>
              </div>
            </div>
          </div>

          <!-- üîπ FORM TARJETA (cuando m√©todo = card) -->
          <form
            *ngIf="paymentMethod() === 'card'"
            [formGroup]="cardForm"
            class="card-form"
            (ngSubmit)="pagar()">

            <div class="card-row">
              <label>
                N√∫mero de tarjeta
                <input type="text"
                       formControlName="card_number"
                       placeholder="4111 1111 1111 1111" />
              </label>
            </div>

            <div class="card-row">
              <label>
                Mes (MM)
                <input type="text"
                       formControlName="expiration_month"
                       placeholder="09" />
              </label>

              <label>
                A√±o (YYYY)
                <input type="text"
                       formControlName="expiration_year"
                       placeholder="2026" />
              </label>

              <label>
                CVV
                <input type="password"
                       formControlName="cvv"
                       placeholder="123" />
              </label>
            </div>

            <div class="step-actions">
              <button type="button" class="btn ghost" (click)="step.set(2)">
                ‚¨Ö Volver
              </button>
              <button
                type="submit"
                class="btn primary"
                [disabled]="payLoading() || paymentStatus() === 'success'">
                {{ payLoading() ? 'Procesando...' : 'Pagar ahora' }}
              </button>
            </div>
          </form>

          <!-- Overlay de ERROR -->
          <div class="error-overlay" *ngIf="showCardError()">
            <div class="error-modal">
              <div class="error-icon">‚ö†</div>
              <h2>Error en el pago</h2>
              <p>{{ cardError() }}</p>
              <button class="btn primary" (click)="cerrarCardError()">Entendido</button>
            </div>
          </div>

          <!-- üîπ BOT√ìN SIMPLE (Yape / Plin) -->
          <div class="step-actions" *ngIf="paymentMethod() !== 'card'">
            <button type="button" class="btn ghost" (click)="step.set(2)">
              ‚¨Ö Volver
            </button>
            <button
              type="button"
              class="btn primary"
              (click)="pagar()"
              [disabled]="payLoading() || paymentStatus() === 'success'">
              {{ payLoading() ? 'Procesando...' : 'Pagar ahora' }}
            </button>
          </div>

        </section>
      </div>
    </ng-container>

  </section>
</div>
<!-- üîπ Modal de CONFIRMACI√ìN de cancelaci√≥n -->
<div class="cancel-overlay" *ngIf="showCancelConfirm()">
  <div class="cancel-modal">
    <div class="cancel-icon">‚ö†</div>
    <h2>Cancelar suscripci√≥n</h2>

    <p class="cancel-text">
      ¬øEst√°s seguro de que quieres cancelar tu suscripci√≥n?
    </p>
    <p class="cancel-hint">
      No se te cobrar√° el siguiente per√≠odo de facturaci√≥n.
    </p>

    <div class="cancel-actions">
      <button class="btn ghost" type="button" (click)="closeCancelConfirm()">
        No, volver
      </button>
      <button class="btn danger" type="button" (click)="confirmCancelSubscription()">
        S√≠, cancelar suscripci√≥n
      </button>
    </div>
  </div>
</div>

<!-- üîπ Modal de RESULTADO de cancelaci√≥n -->
<div class="cancel-overlay" *ngIf="showCancelSuccess()">
  <div class="cancel-modal">
    <div class="cancel-success-icon">‚úî</div>
    <h2>Suscripci√≥n cancelada</h2>

    <p class="cancel-text">
      Su suscripci√≥n fue cancelada. No se le cobrar√° el siguiente mes.
    </p>

    <div class="cancel-actions">
      <button class="btn primary" type="button" (click)="closeCancelSuccess()">
        Entendido
      </button>
    </div>
  </div>
</div>
